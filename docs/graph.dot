digraph pamphlet_pipeline {

    // ======================================================
    // Using Graphviz sequential 3-color scheme 'gnbu3'
    // Hierarchy:
    //   1 = lightest → top-level clusters
    //   2 = medium  → sub-clusters
    //   3 = darkest → nodes
    // ======================================================

    splines=polyline;    // or: splines=ortho or splines=polyline
    rankdir=TB;
    colorscheme=gnbu3;
    ranksep=0.4;
    nodesep=0.3;
    fontname="Figtree";

    node [
        shape=box,
        style=filled,
        fontname="Figtree",
        width=3,
        fixedsize=false,
        fontsize=12,
        margin="0.3,0.3",
        fillcolor="1",
        fontcolor="black",
        colorscheme=oranges9
    ];

    // =========================
    // Training Phase
    // =========================
    subgraph cluster_training {
        label="Training Phase";
        fontweight="light";
        fontname="Figtree Light";
        fontsize=32;
        style=filled;
        fillcolor="1";  

        node [
            style=filled
            fillcolor="3",
            fontsize="12"
        ];

        EEBO_TEI_XML     [label="EEBO-TCP XML\nGold standard", shape=folder];
        EEBO_images      [label="EEBO Page Images\n(public domain / via Oxford)", shape=folder, ];
        MacBERTh_training [label="Fine-tune MacBERTh\non OCR + TEI XML\nproduces fine-tuned model", shape=parallelogram];

        merge_training [label="", shape=circle, width=0.2, fixedsize=true, fillcolor="3"];
    }

    MacBERTh_Fine_Tuned [
        label="Fine-tuned\nMacBERTh",
        shape=cylinder,
        style=filled,
        fillcolor="3"
    ];

    // =========================
    // Production Phase
    // =========================
    subgraph cluster_production {
        label="Production Phase";
        fontname="Figtree Light";
        fontsize=32;
        style=filled;
        fillcolor="1";

        // Digitisation
        subgraph cluster_digitisation {
            label="Digitisation";
            fontname="Figtree Light";
            fontsize=24;
            style=filled;
            fillcolor="2";

            node [style=filled, fillcolor="3"];

            Lincoln_scans [label="Lincoln College/Bodleian\nScan pamphlets", shape=folder];
            OCR_tool      [label="Kraken / Transkribus\nOCR / HTR", shape=parallelogram];
        }

        // TEI Generation
        subgraph cluster_tei_generation {
            label="TEI Generation";
            fontname="Figtree Light";
            fontsize=24;
            style=filled;
            fillcolor="2";

            node [style=filled, fillcolor="3"];

            MACBERTH_OCR2TEI [label="Fine-Tuned MacBERTh\nproduces TEI from OCR"];
            Lincoln_TEI      [label="Lincoln/Bodleian TEI Outputs", shape=cylinder];
        }

        // Dictionary / Normalisation
        subgraph cluster_dictionary {
            label="Linguistic Normalisation / Mapping";
            fontname="Figtree Light";
            fontsize=24;
            style=filled;
            fillcolor="2";

            node [style=filled, fillcolor="3"];

            EME_to_ME_dict [label="Normalisation of EME to ME via dictionary/library"];
            Normaliser_DB  [label="EME to ME Dictionary", shape=cylinder];
        }
    }

    // =========================
    // Analysis Phase
    // =========================
    subgraph cluster_analysis {
        label="Analysis Phase";
        fontname="Figtree Light";
        fontsize=32;
        style=filled;
        fillcolor="1";

        // Computation
        subgraph cluster_computation {
            label="Computational Processes";
            fontname="Figtree Light";
            fontsize=24;
            style=filled;
            fillcolor="2";

            node [style=filled, fillcolor="3"];

            MacBERTh_analysis [label="MacBERTh for Analysis"];
            DB                [label="TEI Database (PostGres)", shape=cylinder];
            IFI               [label="Inverse Frequency Index"];
            RAG_index         [label="RAG Index (FAISS)\nideological clusters,\nphrase reuse"];
        }

        // Outputs
        subgraph cluster_outputs {
            label="Analytical &amp; Interpretative Outputs";
            fontname="Figtree Light";
            fontsize=24;
            labelloc=b;
            labeljust=c;
            style=filled;
            fillcolor="2";

            node [style=filled, fillcolor="3"];

            Semantic_drift        [label="Semantic Drift\nvia dynamic embeddings"];
            Network_analysis      [label="Network Analysis\ncitation, phrase-sharing,\nauthorial & geo-temporal diffusion"];
            Geo_temporal_mapping  [label="Pamphlets, ideas & drift\nmapped across time and space"];
            Historical_context    [label="Computational outputs grounded\nin early modern print culture"];
            Interpretation        [label="Historically-informed Interpretation"];
            Meta                  [label="Conceptual Metaphors As Deep Semantic Frames..."];
        }

        // Edges (computational → interpretative)
        MacBERTh_analysis -> Semantic_drift;
        MacBERTh_analysis -> Network_analysis;
        DB                -> Semantic_drift;
        DB                -> Network_analysis;
        IFI               -> Semantic_drift;
        RAG_index         -> Semantic_drift;
        MacBERTh_analysis -> Geo_temporal_mapping;
        DB                -> Historical_context;
        Semantic_drift       -> Interpretation;
        Network_analysis     -> Interpretation;
        Geo_temporal_mapping -> Interpretation;
        Historical_context   -> Interpretation;
        Meta -> Interpretation;

        EME_to_ME_dict -> DB [label="TEI Entries"];
        Normaliser_DB  -> EME_to_ME_dict;
    }

    // Training edges
    EEBO_images    -> merge_training;
    EEBO_TEI_XML   -> merge_training;
    merge_training -> MacBERTh_training [label="OCR + Gold TEI"];

    // Production edges
    Lincoln_scans -> OCR_tool;
    OCR_tool      -> MACBERTH_OCR2TEI;
    MacBERTh_training -> MacBERTh_Fine_Tuned;
    MacBERTh_Fine_Tuned -> MACBERTH_OCR2TEI;
    MACBERTH_OCR2TEI -> Lincoln_TEI;
    Lincoln_TEI -> EME_to_ME_dict [style=dotted, label="For normalisation"];

    // Analysis edges
    DB -> MacBERTh_analysis;
    DB -> RAG_index;
    DB -> IFI;

    // Invisible ordering constraints
    MacBERTh_training -> Lincoln_scans [style=invis];
    Lincoln_TEI       -> MacBERTh_analysis [style=invis];
}
